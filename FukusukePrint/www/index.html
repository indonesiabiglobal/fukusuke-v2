<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fukusuke Print</title>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
            }

            #homepage {
                font-family: Arial;
                padding: 20px;
                display: block;
            }

            #laravelFrame {
                width: 100%;
                height: 100vh;
                border: none;
                display: none;
            }

            button {
                width: 100%;
                padding: 15px;
                margin: 10px 0;
                font-size: 18px;
            }
            .success {
                background: #4caf50;
                color: white;
                border: none;
            }
            .info {
                background: #2196f3;
                color: white;
                border: none;
            }
            .warning {
                background: #ff9800;
                color: white;
                border: none;
            }

            #log {
                background: #000;
                color: #0f0;
                padding: 10px;
                margin-top: 15px;
                font-family: monospace;
                font-size: 12px;
                max-height: 300px;
                overflow-y: auto;
            }

            #printerStatus {
                padding: 10px;
                margin: 10px 0;
                background: #f0f0f0;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <!-- HOME PAGE -->
        <div id="homepage">
            <h1>üñ®Ô∏è Fukusuke Print</h1>
            <p id="status">Initializing...</p>

            <div id="printerStatus">
                <strong>Printer:</strong>
                <span id="connectedPrinter">Not detected</span>
            </div>

            <button class="info" onclick="scanPrinter()">
                üîç Scan Printer
            </button>
            <button class="success" onclick="testPrint()">üñ®Ô∏è Test Print</button>
            <button class="warning" onclick="openBluetoothSettings()">
                ‚öôÔ∏è Bluetooth Settings
            </button>
            <button onclick="openLaravel()">üåê Open Laravel</button>

            <div id="log"></div>
        </div>

        <!-- LARAVEL IFRAME (hidden by default) -->
        <iframe id="laravelFrame"></iframe>

        <script src="cordova.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
        <script src="js/thermal-printer-cordova.js"></script>

        <script>
            let connectedPrinter = null;

            function log(msg) {
                const logDiv = document.getElementById("log");
                if (logDiv) {
                    logDiv.innerHTML += msg + "<br>";
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
                console.log(msg);
            }

            function updatePrinterStatus(name, address) {
                const statusEl = document.getElementById("connectedPrinter");
                if (name && address) {
                    statusEl.innerHTML = `‚úÖ ${name}<br><small>${address}</small>`;
                    connectedPrinter = { name, address };
                } else {
                    statusEl.textContent = "‚ùå Not connected";
                    connectedPrinter = null;
                }
            }

            /* ===== PERMISSIONS ===== */
            function requestBtPermission() {
                if (!cordova.plugins || !cordova.plugins.permissions) {
                    log("‚ö†Ô∏è Permission plugin not available");
                    return;
                }

                const p = cordova.plugins.permissions;
                const permissions = [
                    p.BLUETOOTH_CONNECT,
                    p.BLUETOOTH_SCAN,
                    p.ACCESS_FINE_LOCATION,
                ];

                p.requestPermissions(
                    permissions,
                    function (status) {
                        if (status.hasPermission) {
                            log("‚úÖ Bluetooth permissions GRANTED");
                            scanPrinter();
                        } else {
                            log("‚ùå Bluetooth permissions DENIED");
                        }
                    },
                    function (err) {
                        log("‚ùå Permission error: " + err);
                    }
                );
            }

            /* ===== DEVICE READY ===== */
            document.addEventListener(
                "deviceready",
                function () {
                    document.getElementById("status").textContent =
                        "‚úÖ Device Ready";
                    log("‚úÖ Cordova deviceready");
                    log(
                        "bluetoothSerial: " +
                            (typeof bluetoothSerial !== "undefined"
                                ? "YES"
                                : "NO")
                    );

                    requestBtPermission();
                },
                false
            );

            /* ===== SCAN PRINTER ===== */
            function scanPrinter() {
                log("=== Scanning for Printer ===");

                if (typeof bluetoothSerial === "undefined") {
                    log("‚ùå bluetoothSerial not available");
                    return;
                }

                bluetoothSerial.isEnabled(
                    function () {
                        bluetoothSerial.list(
                            function (devices) {
                                log(
                                    "Found " +
                                        devices.length +
                                        " paired devices"
                                );

                                if (devices.length === 0) {
                                    log("‚ùå No paired devices");
                                    updatePrinterStatus(null, null);
                                    return;
                                }

                                const printers = devices.filter(
                                    (d) => d.name && d.name.includes("TM-P20")
                                );

                                if (printers.length === 0) {
                                    log("‚ùå No TM-P20 printers found");
                                    devices.forEach((d, i) =>
                                        log(i + 1 + ". " + d.name)
                                    );
                                    updatePrinterStatus(null, null);
                                    return;
                                }

                                printers.forEach((p, i) => {
                                    log(
                                        i +
                                            1 +
                                            ". " +
                                            p.name +
                                            " (" +
                                            p.address +
                                            ")"
                                    );
                                });

                                if (printers.length === 1) {
                                    log(
                                        "‚úÖ Auto-selected: " + printers[0].name
                                    );
                                    selectPrinter(printers[0]);
                                } else {
                                    showPrinterSelection(printers);
                                }
                            },
                            function (err) {
                                log("‚ùå List error: " + err);
                            }
                        );
                    },
                    function () {
                        log("‚ö†Ô∏è Bluetooth is DISABLED");
                        bluetoothSerial.enable(
                            function () {
                                log("‚úÖ Bluetooth enabled");
                                setTimeout(scanPrinter, 1000);
                            },
                            function (err) {
                                log("‚ùå Enable failed: " + err);
                            }
                        );
                    }
                );
            }

            function showPrinterSelection(printers) {
                let message = "Pilih Printer:\n\n";
                printers.forEach((p, i) => {
                    message += i + 1 + ". " + p.name + "\n";
                });
                message += "\nMasukkan nomor (1-" + printers.length + "):";

                const choice = prompt(message);
                if (!choice) {
                    log("‚ùå Selection cancelled");
                    return;
                }

                const index = parseInt(choice) - 1;
                if (index < 0 || index >= printers.length) {
                    log("‚ùå Invalid selection");
                    return;
                }

                selectPrinter(printers[index]);
            }

            function selectPrinter(printer) {
                log("‚úÖ Selected: " + printer.name);
                updatePrinterStatus(printer.name, printer.address);
                localStorage.setItem("printer_name", printer.name);
                localStorage.setItem("printer_address", printer.address);
                connectedPrinter = printer;
            }

            /* ===== TEST PRINT ===== */
            async function testPrint() {
                log("=== Test Print ===");

                if (!connectedPrinter) {
                    log("‚ùå No printer detected");
                    return;
                }

                const data = {
                    gentan_no: "12345",
                    lpk_no: "123456-001",
                    product_name: "TEST PRODUCT",
                    code: "ORD-001",
                    code_alias: "TST",
                    production_date: "2026-01-02",
                    work_hour: "08:00",
                    work_shift: "Pagi",
                    machineno: "M-01",
                    berat_produksi: "100",
                    panjang_produksi: "500",
                    selisih: "5",
                    nomor_han: "H-001",
                    nik: "123456",
                    empname: "TEST USER",
                };

                try {
                    log("üîå Connecting to " + connectedPrinter.name + "...");

                    await new Promise((resolve, reject) => {
                        bluetoothSerial.connect(
                            connectedPrinter.address,
                            resolve,
                            reject
                        );
                    });

                    log("‚úÖ Connected!");
                    log("üìù Generating print data...");

                    const escPosBytes = await window.generateEscPosCommands(
                        data
                    );
                    const byteArray = Array.from(escPosBytes);

                    log("üñ®Ô∏è Printing " + byteArray.length + " bytes...");

                    const chunkSize = 512;
                    for (let i = 0; i < byteArray.length; i += chunkSize) {
                        const chunk = byteArray.slice(i, i + chunkSize);
                        await new Promise((resolve, reject) => {
                            bluetoothSerial.write(chunk, resolve, reject);
                        });
                        await new Promise((r) => setTimeout(r, 100));
                    }

                    log("‚úÖ Print SUCCESS!");
                    bluetoothSerial.disconnect();
                } catch (e) {
                    log("‚ùå Print error: " + e);
                    bluetoothSerial.disconnect();
                }
            }

            /* ===== BLUETOOTH SETTINGS ===== */
            function openBluetoothSettings() {
                if (typeof bluetoothSerial !== "undefined") {
                    bluetoothSerial.showBluetoothSettings(
                        function () {
                            setTimeout(scanPrinter, 2000);
                        },
                        function (err) {
                            log("‚ùå Cannot open settings: " + err);
                        }
                    );
                }
            }

            /* ===== OPEN LARAVEL IN IFRAME ===== */
            function openLaravel() {
                if (!connectedPrinter) {
                    alert("‚ö†Ô∏è Pilih printer dulu!");
                    return;
                }

                log("üåê Loading Laravel in iframe...");

                // Save printer info
                localStorage.setItem("CORDOVA_MODE", "true");
                localStorage.setItem("printer_name", connectedPrinter.name);
                localStorage.setItem(
                    "printer_address",
                    connectedPrinter.address
                );

                // Hide home, show iframe
                document.getElementById("homepage").style.display = "none";
                const iframe = document.getElementById("laravelFrame");
                iframe.style.display = "block";

                log("üì° Loading: https://fukusuke-kogyo-sys.co.id/login");
                iframe.src = "https://fukusuke-kogyo-sys.co.id/login";

                log("‚úÖ Laravel loaded!");
            }
        </script>
    </body>
</html>
